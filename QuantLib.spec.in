# Define some specific macros
%define _aclocaldir %{_datadir}/aclocal
%define docdir %{_prefix}/doc/QuantLib-%{version}

# Check whether cppunit is install. If it is then
# build the test-suite package
%define test %(if rpm -q cppunit cppunit-static cppunit-devel 2>&1 > /dev/null; then echo 1; else echo 0;fi)

Summary: The free/open-source library for quantitative finance.
Name: QuantLib
Version: @PACKAGE_VERSION@
Epoch: 0
Release: 1
License: BSD License
Group: System Environment/Libraries
Packager: Liguo Song (Leo) <liguo.song@vanderbilt.edu>
Vendor: QuantLib.org
Source0: http://prdownloads.sourceforge.net/quantlib/QuantLib-%{version}.tar.gz
URL: http://quantlib.org/
Buildroot: %{_tmppath}/%{name}-%{version}-root
BuildRequires: automake >= 1.7, autoconf >= 2.54

%description
QuantLib is an open source C++ library for financial quantitative analysts 
and developers. 

%package devel
Summary: The header files and the static library.
Group: Development/Libraries
Requires: QuantLib = %{version}
BuildRequires: automake >= 1.7, autoconf >= 2.54

%description devel
QuantLib is an open source C++ library for financial quantitative analysts 
and developers. 

Install QuantLib-devel if you are going to develop programs which will
use the standard C libraries.

%if %test
%package test-suite
Summary: The test-suite to check the setup of quantlib installation.
Group: Development/Tools
Requires: QuantLib = %{version}, cppunit >= 1.8.0, cppunit-devel >= 1.8.0, cppunit-static >= 1.8.0

%description test-suite
QuantLib is an open source C++ library for financial quantitative analysts 
and developers. 

The QuantLib-test-suite will validate the compiled code against pre-constructed test
cases, and helps in validating the library.
%endif

%package doc
Summary: The documentations for QuantLib.
Group: Documentation
Requires: QuantLib = %{version}
BuildRequires: doxygen >= 1.3, graphviz

%description doc
QuantLib is an open source C++ library for financial quantitative analysts 
and developers. 

This package contains documentation files generated from the source code of
QuantLib.

You'll want to install this package if you need a reference to QuantLib.

%prep
%setup -q 
%if !%test
rm %{buildroot}%{_prefix}/bin/quantlib-test-suite
rm %{buildroot}%{_prefix}/man/man1/quantlib-test-suite.1
%endif 

%build
CFLAGS="${CFLAGS:-%optflags}" ; export CFLAGS ; \
CXXFLAGS="${CXXFLAGS:-%optflags}" ; export CXXFLAGS ; \
FFLAGS="${FFLAGS:-%optflags}" ; export FFLAGS ; \
./configure --prefix=%{_prefix}
make
# make documentations
cd Docs
make docs-all

%install
rm -rf %{buildroot}
make prefix=%{buildroot}%{_prefix} install
%if !%test
rm -f %{buildroot}%{_prefix}/bin/quantlib-test-suite
rm -f %{buildroot}%{_prefix}/man/man1/quantlib-test-suite.1
echo "Warning: quantlib-test-suite is not built!"
echo "Warning: cppunit, cppunit-devel and cppunit-static are needed!"
%endif 
# install the documentation
mkdir -p %{buildroot}%{docdir}
cp -p Authors.txt LICENSE.TXT ChangeLog.txt Readme.txt %{buildroot}%{docdir} 
cp -p Contributors.txt History.txt INSTALL.txt TODO.txt %{buildroot}%{docdir} 
cp -p News.txt  %{buildroot}%{docdir}
cp -pr Examples %{buildroot}%{docdir}
cp -pr Docs/html %{buildroot}%{docdir}
rm -f %{buildroot}%{docdir}/html/*.dot
cp -p Docs/latex/refman.pdf %{buildroot}%{docdir}/QuantLib-%{version}-docs-refman.pdf
cp -p Docs/latex/refman.ps %{buildroot}%{docdir}/QuantLib-%{version}-docs-refman.ps
cp -pr Docs/man/man3 %{buildroot}%{_mandir}/

%clean
rm -rf %{buildroot}

%post -p /sbin/ldconfig

%postun -p /sbin/ldconfig

%files
%defattr(-,root,root)
%{docdir}/Authors.txt 
%{docdir}/LICENSE.TXT
%{docdir}/ChangeLog.txt
%{docdir}/Readme.txt
%{docdir}/News.txt 
%{docdir}/Contributors.txt
%{docdir}/History.txt
%{docdir}/INSTALL.txt
%{docdir}/TODO.txt
%{_libdir}/libQuantLib.la
%{_libdir}/libQuantLib.so.0
%{_libdir}/libQuantLib.so.0.0.0

%files devel
%defattr(-,root,root)
%{docdir}/Examples
%{_includedir}/ql/
%{_libdir}/libQuantLib.a
%{_libdir}/libQuantLib.so
%{_datadir}/aclocal/*
%{_datadir}/emacs/site-lisp/*
%{_bindir}/quantlib-config
%{_mandir}/man1/quantlib-config.1

%if %test
%files test-suite
%defattr(-,root,root)
%{_mandir}/man1/quantlib-test-suite.1
%{_bindir}/quantlib-test-suite
%endif

%files doc
%defattr(-,root,root)
%{_mandir}/man3/*
%{docdir}/html
%{docdir}/QuantLib-%{version}-docs-refman.pdf
%{docdir}/QuantLib-%{version}-docs-refman.ps

%changelog
* Thu Oct 2 2003 Liguo Song <liguo.song@vanderbilt.edu>
- Add docs package
- Modified Makefile.am and Makefile.in in Docs/: 
    $(DVIPS) refman -> $(DVIPS) -o refman.ps refman

* Tue Aug 22 2003 Liguo Song <liguo.song@vanderbilt.edu>
- Initial package. Refer to Changelog.txt for previous changes.
- RPM package beta test
